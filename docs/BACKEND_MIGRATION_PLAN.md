# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ç§»è¡Œè¨ˆç”»

**ä½œæˆæ—¥**: 2025å¹´11æœˆ8æ—¥
**ç›®çš„**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®è¤‡é›‘ãªå‡¦ç†ã‚’ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ç§»è¡Œã—ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã‚’å‘ä¸Šã•ã›ã‚‹

---

## ğŸ“‹ ç§»è¡Œã®å¿…è¦æ€§

### ç¾çŠ¶ã®èª²é¡Œ

1. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯**
   - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—ã€ãƒ¬ãƒ™ãƒ«è¨ˆç®—ã‚’å®Ÿè¡Œ
   - æ”¹ã–ã‚“å¯èƒ½ï¼ˆDevToolsã§ç°¡å˜ã«å¤‰æ›´å¯èƒ½ï¼‰
   - ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿é€ä¿¡ã‚’é˜²ã’ãªã„

2. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œ**
   - ãƒ¡ãƒ¢ã‚«ãƒ¼ãƒ‰ç”»åƒç”Ÿæˆã§ãƒ–ãƒ©ã‚¦ã‚¶ãŒãƒ•ãƒªãƒ¼ã‚º
   - å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
   - ãƒ¢ãƒã‚¤ãƒ«ç«¯æœ«ã§ã®ãƒãƒƒãƒ†ãƒªãƒ¼æ¶ˆè²»ãŒå¤§ãã„

3. **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã®é™ç•Œ**
   - è¤‡é›‘ãªå‡¦ç†ãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã«é›†ä¸­
   - ã‚µãƒ¼ãƒãƒ¼å´ã§ã®ãƒ­ã‚°åˆ†æãŒã§ããªã„
   - A/Bãƒ†ã‚¹ãƒˆã‚„æ©Ÿèƒ½ãƒ•ãƒ©ã‚°ã®å®Ÿè£…ãŒå›°é›£

4. **åŒæœŸå•é¡Œ**
   - è¤‡æ•°ãƒ‡ãƒã‚¤ã‚¹é–“ã§ã®ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§
   - ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã®å‡¦ç†ãŒè¤‡é›‘

### ç§»è¡Œã«ã‚ˆã‚‹æœŸå¾…åŠ¹æœ

| æŒ‡æ¨™ | ç§»è¡Œå‰ | ç§»è¡Œå¾Œï¼ˆäºˆæ¸¬ï¼‰ | æ”¹å–„ç‡ |
|:-----|-------:|---------------:|-------:|
| ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´CPUä½¿ç”¨ç‡ | 100% | 30% | -70% |
| åˆå›èª­ã¿è¾¼ã¿æ™‚é–“ | 3.5ç§’ | 1.2ç§’ | -66% |
| ãƒãƒƒãƒ†ãƒªãƒ¼æ¶ˆè²» | é«˜ | ä½ | -50% |
| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚³ã‚¢ | 60/100 | 95/100 | +58% |
| é–‹ç™ºé€Ÿåº¦ï¼ˆæ–°æ©Ÿèƒ½ï¼‰ | é…ã„ | æ—©ã„ | +200% |

---

## ğŸ¯ ç§»è¡Œå¯¾è±¡ã®å„ªå…ˆé †ä½

### å„ªå…ˆåº¦: é«˜ ğŸ”´ï¼ˆå³æ™‚å¯¾å¿œï¼‰

#### 1. ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†
**ç¾çŠ¶**: `lib/services/gamification_service.dart` (19,759è¡Œ)
- ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—
- ãƒ¬ãƒ™ãƒ«è¨ˆç®—
- ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆè§£é™¤ãƒ­ã‚¸ãƒƒã‚¯

**å•é¡Œç‚¹**:
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ï¼ˆæ”¹ã–ã‚“å¯èƒ½ï¼‰
- è¤‡æ•°ãƒ‡ãƒã‚¤ã‚¹é–“ã®åŒæœŸå•é¡Œ
- CPUãƒ»ãƒãƒƒãƒ†ãƒªãƒ¼æ¶ˆè²»ãŒå¤§ãã„

**ç§»è¡Œå…ˆ**: Supabase Edge Functions + PostgreSQL Functions

**å®Ÿè£…è¨ˆç”»**:
```typescript
// supabase/functions/award-points/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

serve(async (req) => {
  const supabase = createClient(
    Deno.env.get('SUPABASE_URL') ?? '',
    Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
  )

  const { userId, action, metadata } = await req.json()

  // ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã§å®‰å…¨ã«ï¼‰
  const points = calculatePoints(action, metadata)

  // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§æ›´æ–°
  const { data, error } = await supabase.rpc('award_points', {
    p_user_id: userId,
    p_action: action,
    p_points: points,
    p_metadata: metadata
  })

  if (error) throw error

  // ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆè‡ªå‹•ãƒã‚§ãƒƒã‚¯
  await checkAchievements(userId, data)

  return new Response(JSON.stringify(data), {
    headers: { 'Content-Type': 'application/json' }
  })
})
```

**PostgreSQL Function**:
```sql
CREATE OR REPLACE FUNCTION award_points(
  p_user_id UUID,
  p_action TEXT,
  p_points INT,
  p_metadata JSONB DEFAULT '{}'::jsonb
) RETURNS TABLE(
  user_id UUID,
  total_points INT,
  level INT,
  new_achievements TEXT[]
) AS $$
DECLARE
  v_new_points INT;
  v_new_level INT;
  v_achievements TEXT[];
BEGIN
  -- ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ï¼ˆã‚¢ãƒˆãƒŸãƒƒã‚¯æ“ä½œï¼‰
  UPDATE user_stats
  SET
    total_points = total_points + p_points,
    level = calculate_level(total_points + p_points),
    updated_at = NOW()
  WHERE user_stats.user_id = p_user_id
  RETURNING total_points, level INTO v_new_points, v_new_level;

  -- ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ­ã‚°è¨˜éŒ²
  INSERT INTO gamification_logs (user_id, action, points, metadata)
  VALUES (p_user_id, p_action, p_points, p_metadata);

  -- ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆè‡ªå‹•ãƒã‚§ãƒƒã‚¯
  v_achievements := check_and_unlock_achievements(p_user_id);

  RETURN QUERY
  SELECT p_user_id, v_new_points, v_new_level, v_achievements;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

**ç§»è¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«**:
- Week 1: PostgreSQLé–¢æ•°ä½œæˆã¨ãƒ†ã‚¹ãƒˆ
- Week 2: Edge Functionå®Ÿè£…
- Week 3: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çµ±åˆ
- Week 4: æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤

**ãƒªã‚¹ã‚¯**:
- æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨ã®æ•´åˆæ€§
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯

**å¯¾ç­–**:
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œè¨¼
- ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆã§äº‹å‰ç¢ºèª
- ã‚«ãƒŠãƒªã‚¢ãƒªãƒªãƒ¼ã‚¹ï¼ˆ10%ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰æ®µéšçš„ã«ï¼‰

---

#### 2. ãƒ¡ãƒ¢ã‚«ãƒ¼ãƒ‰ç”»åƒç”Ÿæˆ
**ç¾çŠ¶**: `lib/services/note_card_service.dart` (11,490è¡Œ)
- Flutter Widgetã‚’ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ
- é‡ã„ç”»åƒå‡¦ç†

**å•é¡Œç‚¹**:
- ãƒ¢ãƒã‚¤ãƒ«ç«¯æœ«ã§ãƒ•ãƒªãƒ¼ã‚º
- ãƒ¡ãƒ¢ãƒªæ¶ˆè²»ãŒå¤§ãã„ï¼ˆ100MB+ï¼‰
- ç«¯æœ«ã«ã‚ˆã£ã¦å“è³ªãŒç•°ãªã‚‹

**ç§»è¡Œå…ˆ**: Netlify Functions (æ—¢ã«SNSã‚·ã‚§ã‚¢ã§å®Ÿç¸¾ã‚ã‚Š)

**å®Ÿè£…è¨ˆç”»**:
```javascript
// netlify/functions/generate-note-card.js
const { generateNoteCardSVG } = require('./utils/svg-generator')

exports.handler = async (event) => {
  const { title, content, level, points, theme } = JSON.parse(event.body)

  // SVGç”Ÿæˆï¼ˆè»½é‡ã€é«˜å“è³ªã€ä¸€è²«æ€§ï¼‰
  const svg = generateNoteCardSVG({
    title,
    content: content.substring(0, 200), // æœ€åˆã®200æ–‡å­—
    level,
    points,
    theme: theme || 'default',
    width: 1200,
    height: 630
  })

  return {
    statusCode: 200,
    headers: {
      'Content-Type': 'image/svg+xml; charset=utf-8',
      'Cache-Control': 'public, max-age=3600'
    },
    body: svg
  }
}
```

**SVGç”Ÿæˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£**:
```javascript
// netlify/functions/utils/svg-generator.js
function generateNoteCardSVG({ title, content, level, points, theme, width, height }) {
  const themes = {
    default: { bg: '#667eea', text: '#fff' },
    dark: { bg: '#1a202c', text: '#fff' },
    light: { bg: '#f7fafc', text: '#1a202c' }
  }

  const colors = themes[theme] || themes.default

  return `
    <svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="bg" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:${colors.bg};stop-opacity:1" />
          <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
        </linearGradient>
      </defs>

      <rect width="${width}" height="${height}" fill="url(#bg)"/>

      <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
      <text x="60" y="100" font-family="Arial, sans-serif" font-size="48"
            font-weight="bold" fill="${colors.text}">
        ${escapeXml(title)}
      </text>

      <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
      <text x="60" y="180" font-family="Arial, sans-serif" font-size="24"
            fill="${colors.text}" opacity="0.9">
        ${escapeXml(content)}
      </text>

      <!-- ãƒ¬ãƒ™ãƒ«ãƒ»ãƒã‚¤ãƒ³ãƒˆ -->
      <text x="60" y="${height - 60}" font-family="Arial, sans-serif"
            font-size="32" fill="${colors.text}">
        Level ${level} â€¢ ${points.toLocaleString()} pts
      </text>
    </svg>
  `
}

function escapeXml(str) {
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&apos;')
}

module.exports = { generateNoteCardSVG }
```

**ç§»è¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«**:
- Week 1: SVGç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…
- Week 2: Netlify Functionä½œæˆã¨ãƒ†ã‚¹ãƒˆ
- Week 3: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çµ±åˆ
- Week 4: æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤

**åŠ¹æœ**:
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ãƒ¡ãƒ¢ãƒªæ¶ˆè²» -90%
- ç”»åƒç”Ÿæˆæ™‚é–“ 3ç§’ â†’ 0.5ç§’
- ä¸€è²«ã—ãŸç”»è³ª

---

#### 3. ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†
**ç¾çŠ¶**: `lib/services/import_service.dart` (9,738è¡Œ)
- Notion/Evernoteãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ãƒ¼ã‚¹
- å…¨ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´

**å•é¡Œç‚¹**:
- å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
- ãƒ–ãƒ©ã‚¦ã‚¶ãŒãƒ•ãƒªãƒ¼ã‚º
- ãƒ¡ãƒ¢ãƒªä¸è¶³ã‚¨ãƒ©ãƒ¼

**ç§»è¡Œå…ˆ**: Supabase Edge Functions + ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¸ãƒ§ãƒ–

**å®Ÿè£…è¨ˆç”»ï¼ˆéåŒæœŸå‡¦ç†ï¼‰**:
```typescript
// supabase/functions/import-notes/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'

serve(async (req) => {
  const { userId, fileUrl, source } = await req.json()

  // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¸ãƒ§ãƒ–ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
  const { data: job, error } = await supabase
    .from('import_jobs')
    .insert({
      user_id: userId,
      file_url: fileUrl,
      source: source,
      status: 'queued',
      progress: 0
    })
    .select()
    .single()

  if (error) throw error

  // åˆ¥ã®Edge Functionã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ã‚’é–‹å§‹
  fetch(`${Deno.env.get('SUPABASE_URL')}/functions/v1/process-import`, {
    method: 'POST',
    body: JSON.stringify({ jobId: job.id })
  })

  return new Response(JSON.stringify({
    jobId: job.id,
    message: 'Import job queued',
    statusUrl: `/api/import-status/${job.id}`
  }), {
    headers: { 'Content-Type': 'application/json' }
  })
})
```

**ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†**:
```typescript
// supabase/functions/process-import/index.ts
serve(async (req) => {
  const { jobId } = await req.json()

  // ã‚¸ãƒ§ãƒ–å–å¾—
  const { data: job } = await supabase
    .from('import_jobs')
    .select('*')
    .eq('id', jobId)
    .single()

  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°: processing
  await updateJobStatus(jobId, 'processing', 0)

  try {
    // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    const fileData = await fetch(job.file_url).then(r => r.text())

    // ãƒ‘ãƒ¼ã‚¹ï¼ˆNotion/Evernoteå½¢å¼ã«å¿œã˜ã¦ï¼‰
    const notes = parseImportFile(fileData, job.source)

    // ãƒãƒƒãƒã‚¤ãƒ³ã‚µãƒ¼ãƒˆï¼ˆ1000ä»¶ãšã¤ï¼‰
    const batchSize = 1000
    for (let i = 0; i < notes.length; i += batchSize) {
      const batch = notes.slice(i, i + batchSize)

      await supabase.from('notes').insert(
        batch.map(note => ({
          user_id: job.user_id,
          title: note.title,
          content: note.content,
          category_id: note.categoryId,
          created_at: note.createdAt
        }))
      )

      // é€²æ—æ›´æ–°
      const progress = Math.floor(((i + batchSize) / notes.length) * 100)
      await updateJobStatus(jobId, 'processing', progress)
    }

    // å®Œäº†
    await updateJobStatus(jobId, 'completed', 100, {
      imported_count: notes.length
    })

  } catch (error) {
    await updateJobStatus(jobId, 'failed', 0, {
      error: error.message
    })
  }

  return new Response(JSON.stringify({ success: true }))
})

async function updateJobStatus(jobId, status, progress, metadata = {}) {
  await supabase
    .from('import_jobs')
    .update({
      status,
      progress,
      metadata,
      updated_at: new Date().toISOString()
    })
    .eq('id', jobId)
}
```

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ**:
```sql
CREATE TABLE import_jobs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) NOT NULL,
  file_url TEXT NOT NULL,
  source TEXT NOT NULL, -- 'notion' or 'evernote'
  status TEXT NOT NULL DEFAULT 'queued', -- queued, processing, completed, failed
  progress INT DEFAULT 0, -- 0-100
  metadata JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_import_jobs_user_id ON import_jobs(user_id);
CREATE INDEX idx_import_jobs_status ON import_jobs(status);
```

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆé€²æ—è¡¨ç¤ºï¼‰**:
```dart
// lib/services/import_service.dart
class ImportService {
  Future<String> startImport(String fileUrl, String source) async {
    final response = await supabase.functions.invoke('import-notes', body: {
      'userId': supabase.auth.currentUser!.id,
      'fileUrl': fileUrl,
      'source': source,
    });

    return response.data['jobId'];
  }

  Stream<ImportJob> watchImportProgress(String jobId) {
    return supabase
        .from('import_jobs')
        .stream(primaryKey: ['id'])
        .eq('id', jobId)
        .map((data) => ImportJob.fromJson(data.first));
  }
}
```

**ç§»è¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«**:
- Week 1-2: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¸ãƒ§ãƒ–ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ
- Week 3: Edge Functionså®Ÿè£…
- Week 4: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çµ±åˆï¼ˆé€²æ—ãƒãƒ¼ï¼‰
- Week 5: æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤

**åŠ¹æœ**:
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå•é¡Œã®è§£æ¶ˆ
- å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œï¼ˆ10ä¸‡ãƒ¡ãƒ¢ä»¥ä¸Šï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ä»–ã®æ“ä½œã‚’ç¶™ç¶šå¯èƒ½

---

### å„ªå…ˆåº¦: ä¸­ ğŸŸ¡ï¼ˆ1-2ãƒ¶æœˆä»¥å†…ï¼‰

#### 4. ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸é€²æ—è¨ˆç®—
**ç¾çŠ¶**: `lib/services/daily_challenge_service.dart` (6,838è¡Œ)

**ç§»è¡Œå…ˆ**: Supabase Database Triggers

```sql
-- ãƒ¡ãƒ¢ä½œæˆæ™‚ã«è‡ªå‹•çš„ã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸é€²æ—ã‚’æ›´æ–°
CREATE OR REPLACE FUNCTION update_challenge_progress()
RETURNS TRIGGER AS $$
BEGIN
  -- ä»Šæ—¥ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸é€²æ—ã‚’æ›´æ–°
  INSERT INTO user_challenge_progress (user_id, challenge_id, progress)
  SELECT
    NEW.user_id,
    dc.id,
    1
  FROM daily_challenges dc
  WHERE dc.challenge_date = CURRENT_DATE
    AND dc.challenge_type = 'create_notes'
  ON CONFLICT (user_id, challenge_id)
  DO UPDATE SET
    progress = user_challenge_progress.progress + 1,
    updated_at = NOW();

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_challenge_progress
AFTER INSERT ON notes
FOR EACH ROW
EXECUTE FUNCTION update_challenge_progress();
```

**åŠ¹æœ**:
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—æ›´æ–°
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ãƒ­ã‚¸ãƒƒã‚¯å‰Šæ¸›

---

#### 5. ãƒã‚¤ãƒ©ãƒ«æˆé•·æ–½ç­–ã®åˆ†æ
**ç¾çŠ¶**: `lib/services/viral_growth_service.dart` (6,691è¡Œ)

**ç§»è¡Œå…ˆ**: Supabase Edge Functions + Analytics

**ä¸æ­£é˜²æ­¢ãƒ­ã‚¸ãƒƒã‚¯**:
```typescript
// supabase/functions/track-referral/index.ts
serve(async (req) => {
  const { referralCode, newUserId } = await req.json()

  // ä¸æ­£ãƒã‚§ãƒƒã‚¯1: è‡ªå·±ç´¹ä»‹é˜²æ­¢
  const { data: referrer } = await supabase
    .from('referral_codes')
    .select('user_id')
    .eq('code', referralCode)
    .single()

  if (referrer.user_id === newUserId) {
    throw new Error('Self-referral not allowed')
  }

  // ä¸æ­£ãƒã‚§ãƒƒã‚¯2: IPã‚¢ãƒ‰ãƒ¬ã‚¹é‡è¤‡ãƒã‚§ãƒƒã‚¯
  const clientIp = req.headers.get('x-forwarded-for')
  const recentReferrals = await supabase
    .from('referrals')
    .select('id')
    .eq('referrer_id', referrer.user_id)
    .eq('metadata->>ip', clientIp)
    .gte('created_at', new Date(Date.now() - 24*60*60*1000).toISOString())

  if (recentReferrals.data.length > 3) {
    throw new Error('Too many referrals from same IP')
  }

  // ç´¹ä»‹è¨˜éŒ²
  await supabase.from('referrals').insert({
    referrer_id: referrer.user_id,
    referred_user_id: newUserId,
    metadata: { ip: clientIp }
  })

  // ãƒã‚¤ãƒ³ãƒˆä»˜ä¸
  await supabase.rpc('award_points', {
    p_user_id: referrer.user_id,
    p_action: 'referral',
    p_points: 1000
  })

  return new Response(JSON.stringify({ success: true }))
})
```

---

#### 6. ãƒ‡ã‚¤ãƒªãƒ¼ãƒ­ã‚°ã‚¤ãƒ³å ±é…¬
**ç¾çŠ¶**: `lib/services/daily_login_service.dart` (4,988è¡Œ)

**ç§»è¡Œå…ˆ**: Supabase Edge Functions + Database Function

```sql
CREATE OR REPLACE FUNCTION claim_daily_login_reward(p_user_id UUID)
RETURNS TABLE(
  reward_points INT,
  current_streak INT,
  message TEXT
) AS $$
DECLARE
  v_last_login DATE;
  v_current_streak INT;
  v_reward_points INT;
BEGIN
  -- æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ—¥å–å¾—
  SELECT last_login_date, login_streak
  INTO v_last_login, v_current_streak
  FROM user_stats
  WHERE user_id = p_user_id;

  -- ä»Šæ—¥æ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
  IF v_last_login = CURRENT_DATE THEN
    RETURN QUERY SELECT 0, v_current_streak, 'Already claimed today';
    RETURN;
  END IF

  -- ã‚¹ãƒˆãƒªãƒ¼ã‚¯è¨ˆç®—
  IF v_last_login = CURRENT_DATE - INTERVAL '1 day' THEN
    v_current_streak := v_current_streak + 1;
  ELSE
    v_current_streak := 1;
  END IF;

  -- å ±é…¬è¨ˆç®—ï¼ˆé€£ç¶šæ—¥æ•°ã«å¿œã˜ã¦å¢—åŠ ï¼‰
  v_reward_points := CASE
    WHEN v_current_streak >= 31 THEN 100
    WHEN v_current_streak >= 15 THEN 50
    WHEN v_current_streak >= 8 THEN 30
    WHEN v_current_streak >= 4 THEN 20
    ELSE 10
  END;

  -- æ›´æ–°
  UPDATE user_stats
  SET
    last_login_date = CURRENT_DATE,
    login_streak = v_current_streak,
    total_points = total_points + v_reward_points
  WHERE user_id = p_user_id;

  RETURN QUERY SELECT v_reward_points, v_current_streak, 'Reward claimed!';
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

---

### å„ªå…ˆåº¦: ä½ ğŸŸ¢ï¼ˆ3ãƒ¶æœˆä»¥é™ï¼‰

#### 7. çµ±è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰é›†è¨ˆ
**ç¾çŠ¶**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§é›†è¨ˆ

**ç§»è¡Œå…ˆ**: Cloudflare Workers + Durable Objectsï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼‰

```javascript
// cloudflare-workers/realtime-stats.js
export default {
  async fetch(request, env) {
    const stats = {
      onlineUsers: await env.STATS.get('online_users'),
      todaySignups: await env.STATS.get('today_signups'),
      totalNotes: await env.STATS.get('total_notes')
    }

    return new Response(JSON.stringify(stats), {
      headers: {
        'Content-Type': 'application/json',
        'Cache-Control': 'public, max-age=10' // 10ç§’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      }
    })
  }
}
```

---

## ğŸ“Š ç§»è¡Œãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

### ãƒ•ã‚§ãƒ¼ã‚º1: åŸºç›¤æ•´å‚™ï¼ˆWeek 1-2ï¼‰
- [x] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ†æå®Œäº†
- [ ] PostgreSQL Functionsè¨­è¨ˆ
- [ ] Edge Functionsé–‹ç™ºç’°å¢ƒæ§‹ç¯‰
- [ ] ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ

### ãƒ•ã‚§ãƒ¼ã‚º2: å„ªå…ˆåº¦é«˜ã®ç§»è¡Œï¼ˆWeek 3-6ï¼‰
- [ ] ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç§»è¡Œ
- [ ] ãƒ¡ãƒ¢ã‚«ãƒ¼ãƒ‰ç”»åƒç”Ÿæˆç§»è¡Œ
- [ ] ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†ç§»è¡Œ
- [ ] ãƒ†ã‚¹ãƒˆï¼†ãƒ‡ãƒãƒƒã‚°

### ãƒ•ã‚§ãƒ¼ã‚º3: å„ªå…ˆåº¦ä¸­ã®ç§»è¡Œï¼ˆWeek 7-10ï¼‰
- [ ] ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ç§»è¡Œ
- [ ] ãƒã‚¤ãƒ©ãƒ«æˆé•·æ–½ç­–ç§»è¡Œ
- [ ] ãƒ‡ã‚¤ãƒªãƒ¼ãƒ­ã‚°ã‚¤ãƒ³å ±é…¬ç§»è¡Œ
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ

### ãƒ•ã‚§ãƒ¼ã‚º4: æœ€é©åŒ–ï¼ˆWeek 11-12ï¼‰
- [ ] Cloudflare Workerså°å…¥æ¤œè¨
- [ ] ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æˆ¦ç•¥å®Ÿè£…
- [ ] ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ï¼†ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

---

## ğŸ”§ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### ç§»è¡Œå¾Œã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Flutter Web (ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰)  â”‚
â”‚  - UI/UXã®ã¿                   â”‚
â”‚  - è»½é‡ãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supabase Edge Functions        â”‚
â”‚  - ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³        â”‚
â”‚  - ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†              â”‚
â”‚  - ãƒã‚¤ãƒ©ãƒ«æˆé•·æ–½ç­–            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL (Supabase)          â”‚
â”‚  - Database Functions          â”‚
â”‚  - Triggers                    â”‚
â”‚  - Row Level Security          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Netlify Functions              â”‚
â”‚  - ãƒ¡ãƒ¢ã‚«ãƒ¼ãƒ‰ç”»åƒç”Ÿæˆ          â”‚
â”‚  - SNSã‚·ã‚§ã‚¢ï¼ˆæ—¢å­˜ï¼‰           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€è¡“é¸å®šç†ç”±

| æŠ€è¡“ | ç”¨é€” | ç†ç”± |
|:-----|:-----|:-----|
| Supabase Edge Functions | ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ | TypeScriptã€ç„¡æ–™æ ã€Supabaseã¨ã®çµ±åˆ |
| PostgreSQL Functions | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ­ã‚¸ãƒƒã‚¯ | ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ |
| Netlify Functions | ç”»åƒç”Ÿæˆ | ç„¡æ–™ã€é«˜é€Ÿã€CDNé…ä¿¡ |
| Cloudflare Workers | çµ±è¨ˆãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆå°†æ¥ï¼‰ | ã‚¨ãƒƒã‚¸ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«å±•é–‹ |

---

## ğŸ“ˆ æˆåŠŸæŒ‡æ¨™

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- [ ] åˆå›èª­ã¿è¾¼ã¿æ™‚é–“: 3.5ç§’ â†’ 1.2ç§’
- [ ] ãƒ¡ãƒ¢ä½œæˆãƒ¬ã‚¹ãƒãƒ³ã‚¹: 500ms â†’ 200ms
- [ ] ç”»åƒç”Ÿæˆæ™‚é–“: 3ç§’ â†’ 0.5ç§’

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- [ ] ãƒã‚¤ãƒ³ãƒˆæ”¹ã–ã‚“é˜²æ­¢: 100%
- [ ] ä¸æ­£ç´¹ä»‹é˜²æ­¢: 95%ä»¥ä¸Š
- [ ] RLSé©ç”¨ç‡: 100%

### ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£
- [ ] åŒæ™‚æ¥ç¶šãƒ¦ãƒ¼ã‚¶ãƒ¼: 100 â†’ 10,000
- [ ] ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¯èƒ½ãªãƒ¡ãƒ¢æ•°: 1,000 â†’ 100,000
- [ ] Edge Functionå®Ÿè¡Œæ™‚é–“: < 1ç§’

---

## ğŸš¨ ãƒªã‚¹ã‚¯ç®¡ç†

### ãƒªã‚¹ã‚¯1: ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®å•é¡Œ
**å¯¾ç­–**:
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‰ã«å®Œå…¨ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
- ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ååˆ†ãƒ†ã‚¹ãƒˆ
- ã‚«ãƒŠãƒªã‚¢ãƒªãƒªãƒ¼ã‚¹ï¼ˆæ®µéšçš„å±•é–‹ï¼‰

### ãƒªã‚¹ã‚¯2: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŠ£åŒ–
**å¯¾ç­–**:
- ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆå®Ÿæ–½
- ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æˆ¦ç•¥
- ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ï¼†ã‚¢ãƒ©ãƒ¼ãƒˆ

### ãƒªã‚¹ã‚¯3: äºˆç®—ã‚ªãƒ¼ãƒãƒ¼
**å¯¾ç­–**:
- Supabaseç„¡æ–™æ ã®ç›£è¦–
- æ®µéšçš„ãªç§»è¡Œï¼ˆä¸€åº¦ã«å…¨ã¦ç§»è¡Œã—ãªã„ï¼‰
- ã‚³ã‚¹ãƒˆæœ€é©åŒ–ï¼ˆä¸è¦ãªAPIå‘¼ã³å‡ºã—å‰Šæ¸›ï¼‰

---

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [PROJECT_ANALYSIS_2025-11-08.md](./PROJECT_ANALYSIS_2025-11-08.md) - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç·åˆåˆ†æ
- [GROWTH_STRATEGY_ROADMAP.md](./GROWTH_STRATEGY_ROADMAP.md) - æˆé•·æˆ¦ç•¥
- [SUPABASE_EDGE_FUNCTIONS_DEPLOY.md](./SUPABASE_EDGE_FUNCTIONS_DEPLOY.md) - Edge Functionsãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

---

**ä½œæˆæ—¥**: 2025å¹´11æœˆ8æ—¥
**æœ€çµ‚æ›´æ–°**: 2025å¹´11æœˆ8æ—¥
**æ¬¡å›ãƒ¬ãƒ“ãƒ¥ãƒ¼**: 2025å¹´11æœˆ22æ—¥
