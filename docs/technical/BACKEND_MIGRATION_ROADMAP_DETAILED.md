# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ç§»è¡Œãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ï¼ˆè©³ç´°ç‰ˆï¼‰

**ä½œæˆæ—¥**: 2025å¹´11æœˆ14æ—¥
**æœ€çµ‚æ›´æ–°**: 2025å¹´11æœˆ14æ—¥
**ç›®çš„**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯ã‚’Supabase Edge Functionsã¸æ®µéšçš„ã«ç§»è¡Œ

---

## ğŸ“Š ç§»è¡Œã®å¿…è¦æ€§

### ç¾åœ¨ã®å•é¡Œ
1. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯**: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã«éœ²å‡º
2. **ä¸æ­£é˜²æ­¢**: ãƒã‚¤ãƒ³ãƒˆã‚„ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆã®æ”¹ã–ã‚“ãŒå¯èƒ½
3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: è¤‡é›‘ãªè¨ˆç®—ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§å®Ÿè¡Œ
4. **ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§**: åŒæ™‚ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã®ç«¶åˆçŠ¶æ…‹
5. **ä¿å®ˆæ€§**: ãƒ­ã‚¸ãƒƒã‚¯ã®é‡è¤‡ï¼ˆWebã€iOSã€Androidï¼‰

### ç§»è¡Œå¾Œã®ãƒ¡ãƒªãƒƒãƒˆ
âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼ˆä¸æ­£é˜²æ­¢ï¼‰
âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã§é«˜é€Ÿå‡¦ç†ï¼‰
âœ… ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®ä¿è¨¼
âœ… ã‚³ãƒ¼ãƒ‰é‡è¤‡ã®å‰Šæ¸›
âœ… ãƒ†ã‚¹ãƒˆã®å®¹æ˜“æ€§

---

## ğŸ¯ ç§»è¡Œå„ªå…ˆé †ä½

### ğŸ”´ Criticalï¼ˆæœ€å„ªå…ˆï¼‰

#### 1. ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç®—
**ç†ç”±**: ä¸æ­£ãªãƒã‚¤ãƒ³ãƒˆç²å¾—ã‚’é˜²ããŸã‚å¿…é ˆ
**ç¾åœ¨ã®å ´æ‰€**: `lib/services/gamification_service.dart`
**å½±éŸ¿**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§

#### 2. ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰é›†è¨ˆ
**ç†ç”±**: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§
**ç¾åœ¨ã®å ´æ‰€**: `lib/services/gamification_service.dart`
**å½±éŸ¿**: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“

#### 3. ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ•ã‚£ãƒ¼ãƒ‰
**ç†ç”±**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦
**ç¾åœ¨ã®å ´æ‰€**: `lib/pages/activity_feed_page.dart`
**å½±éŸ¿**: æ©Ÿèƒ½ã®æ­£å¸¸å‹•ä½œ

### ğŸŸ¡ Highï¼ˆé«˜å„ªå…ˆï¼‰

#### 4. äº’æ›æ€§ã‚¹ã‚³ã‚¢è¨ˆç®—
**ç†ç”±**: ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã€ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ä¿è­·
**ç¾åœ¨ã®å ´æ‰€**: `lib/services/compatibility_service.dart`
**å½±éŸ¿**: ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§

#### 5. ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸åˆ¤å®š
**ç†ç”±**: ä¸æ­£ãªã‚¯ãƒªã‚¢é˜²æ­¢
**ç¾åœ¨ã®å ´æ‰€**: `lib/services/daily_challenge_service.dart`
**å½±éŸ¿**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### ğŸŸ¢ Mediumï¼ˆä¸­å„ªå…ˆï¼‰

#### 6. ãƒ¡ãƒ¢ã‚«ãƒ¼ãƒ‰ç”»åƒç”Ÿæˆ
**ç†ç”±**: ã‚µãƒ¼ãƒãƒ¼å´ã§é«˜å“è³ªãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
**ç¾åœ¨ã®å ´æ‰€**: `lib/widgets/share_note_card_dialog.dart`
**å½±éŸ¿**: ç”»è³ªã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

#### 7. Importå‡¦ç†
**ç†ç”±**: å¤§é‡ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã®åŠ¹ç‡åŒ–
**ç¾åœ¨ã®å ´æ‰€**: `lib/services/import_service.dart`
**å½±éŸ¿**: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

---

## ğŸ“… æ®µéšçš„ç§»è¡Œè¨ˆç”»

### ãƒ•ã‚§ãƒ¼ã‚º1: ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç§»è¡Œï¼ˆé€±1-2ï¼‰

#### 1.1 ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰åŒ–

**ç›®æ¨™**: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—ã‚’å»ƒæ­¢

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢æ•°**:
```sql
-- supabase/migrations/20251114120000_gamification_backend.sql

-- ãƒã‚¤ãƒ³ãƒˆä»˜ä¸é–¢æ•°
CREATE OR REPLACE FUNCTION record_activity(
    p_user_id UUID,
    p_activity_type TEXT,
    p_metadata JSONB DEFAULT '{}'::JSONB
) RETURNS JSON AS $$
DECLARE
    v_points INT;
    v_old_level INT;
    v_new_level INT;
    v_level_up BOOLEAN := FALSE;
    v_achievements JSON[];
BEGIN
    -- ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆã‚’å–å¾—
    SELECT level INTO v_old_level
    FROM user_stats
    WHERE user_id = p_user_id;

    -- ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚¿ã‚¤ãƒ—ã‹ã‚‰ãƒã‚¤ãƒ³ãƒˆã‚’æ±ºå®š
    v_points := CASE p_activity_type
        WHEN 'note_created' THEN 10
        WHEN 'note_updated' THEN 5
        WHEN 'note_deleted' THEN -5
        WHEN 'category_created' THEN 15
        WHEN 'achievement_unlocked' THEN 50
        WHEN 'daily_challenge_completed' THEN 100
        WHEN 'personality_test_completed' THEN 200
        WHEN 'share_note' THEN 20
        WHEN 'invite_friend' THEN 500
        ELSE 0
    END;

    -- ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆã‚’æ›´æ–°
    UPDATE user_stats
    SET
        total_points = total_points + v_points,
        level = FLOOR((total_points + v_points) / 100.0) + 1,
        updated_at = NOW()
    WHERE user_id = p_user_id
    RETURNING level INTO v_new_level;

    -- ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãƒã‚§ãƒƒã‚¯
    IF v_new_level > v_old_level THEN
        v_level_up := TRUE;

        -- ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãƒœãƒ¼ãƒŠã‚¹
        UPDATE user_stats
        SET total_points = total_points + (v_new_level * 50)
        WHERE user_id = p_user_id;
    END IF;

    -- ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’è¨˜éŒ²
    INSERT INTO activities (user_id, activity_type, points, metadata)
    VALUES (p_user_id, p_activity_type, v_points, p_metadata);

    -- ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
    v_achievements := check_achievements(p_user_id, p_activity_type, p_metadata);

    -- çµæœã‚’è¿”ã™
    RETURN json_build_object(
        'points', v_points,
        'total_points', (SELECT total_points FROM user_stats WHERE user_id = p_user_id),
        'old_level', v_old_level,
        'new_level', v_new_level,
        'level_up', v_level_up,
        'achievements', v_achievements
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

**Edge Function**:
```typescript
// supabase/functions/record-activity/index.ts
import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
import { createClient } from '@supabase/supabase-js'

interface ActivityRequest {
  activityType: string
  metadata?: Record<string, any>
}

serve(async (req) => {
  try {
    const authHeader = req.headers.get('Authorization')!
    const supabaseClient = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_ANON_KEY') ?? '',
      { global: { headers: { Authorization: authHeader } } }
    )

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ãƒã‚§ãƒƒã‚¯
    const { data: { user } } = await supabaseClient.auth.getUser()
    if (!user) {
      return new Response(JSON.stringify({ error: 'Unauthorized' }), {
        status: 401,
        headers: { 'Content-Type': 'application/json' },
      })
    }

    const { activityType, metadata = {} }: ActivityRequest = await req.json()

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢æ•°ã‚’å‘¼ã³å‡ºã—
    const { data, error } = await supabaseClient.rpc('record_activity', {
      p_user_id: user.id,
      p_activity_type: activityType,
      p_metadata: metadata
    })

    if (error) throw error

    return new Response(JSON.stringify(data), {
      headers: { 'Content-Type': 'application/json' },
    })
  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' },
    })
  }
})
```

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æ›´æ–°**:
```dart
// lib/services/gamification_service.dartï¼ˆç°¡ç•¥åŒ–ç‰ˆï¼‰
class GamificationService {
  final SupabaseClient _supabase;

  GamificationService(this._supabase);

  /// ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’è¨˜éŒ²ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‘¼ã³å‡ºã—ï¼‰
  Future<GamificationResult> recordActivity(
    String activityType, {
    Map<String, dynamic>? metadata,
  }) async {
    try {
      final response = await _supabase.functions.invoke('record-activity',
        body: {
          'activityType': activityType,
          'metadata': metadata ?? {},
        },
      );

      if (response.status != 200) {
        throw Exception('Failed to record activity: ${response.data}');
      }

      final data = response.data as Map<String, dynamic>;

      return GamificationResult(
        points: data['points'] as int,
        totalPoints: data['total_points'] as int,
        oldLevel: data['old_level'] as int,
        newLevel: data['new_level'] as int,
        levelUp: data['level_up'] as bool,
        achievements: (data['achievements'] as List<dynamic>?)
            ?.map((a) => Achievement.fromJson(a))
            .toList() ?? [],
      );
    } catch (e) {
      print('Error recording activity: $e');
      rethrow;
    }
  }
}
```

**æ¨å®šæ™‚é–“**: 4-6æ™‚é–“
**ãƒ†ã‚¹ãƒˆæ™‚é–“**: 2-3æ™‚é–“

---

#### 1.2 ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰åŒ–

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢æ•°**:
```sql
-- ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯é–¢æ•°
CREATE OR REPLACE FUNCTION check_achievements(
    p_user_id UUID,
    p_activity_type TEXT,
    p_metadata JSONB
) RETURNS JSON[] AS $$
DECLARE
    v_unlocked_achievements JSON[] := ARRAY[]::JSON[];
    v_achievement RECORD;
    v_user_stats RECORD;
BEGIN
    -- ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆã‚’å–å¾—
    SELECT * INTO v_user_stats
    FROM user_stats
    WHERE user_id = p_user_id;

    -- å„ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆã®æ¡ä»¶ã‚’ãƒã‚§ãƒƒã‚¯
    FOR v_achievement IN
        SELECT id, code, type, requirement, requirement_value
        FROM achievements
        WHERE NOT EXISTS (
            SELECT 1 FROM user_achievements
            WHERE user_id = p_user_id AND achievement_id = achievements.id
        )
    LOOP
        -- ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆã®æ¡ä»¶ã‚’è©•ä¾¡
        IF evaluate_achievement_condition(
            v_achievement,
            v_user_stats,
            p_activity_type,
            p_metadata
        ) THEN
            -- ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆã‚’è§£é™¤
            INSERT INTO user_achievements (user_id, achievement_id, unlocked_at)
            VALUES (p_user_id, v_achievement.id, NOW());

            -- é…åˆ—ã«è¿½åŠ 
            v_unlocked_achievements := array_append(
                v_unlocked_achievements,
                row_to_json(v_achievement)
            );

            -- ãƒœãƒ¼ãƒŠã‚¹ãƒã‚¤ãƒ³ãƒˆä»˜ä¸
            UPDATE user_stats
            SET total_points = total_points + 50
            WHERE user_id = p_user_id;
        END IF;
    END LOOP;

    RETURN v_unlocked_achievements;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆæ¡ä»¶è©•ä¾¡é–¢æ•°
CREATE OR REPLACE FUNCTION evaluate_achievement_condition(
    p_achievement RECORD,
    p_user_stats RECORD,
    p_activity_type TEXT,
    p_metadata JSONB
) RETURNS BOOLEAN AS $$
BEGIN
    RETURN CASE p_achievement.type
        WHEN 'note_count' THEN
            p_user_stats.total_notes >= p_achievement.requirement_value
        WHEN 'points_total' THEN
            p_user_stats.total_points >= p_achievement.requirement_value
        WHEN 'level_reached' THEN
            p_user_stats.level >= p_achievement.requirement_value
        WHEN 'daily_streak' THEN
            p_user_stats.current_streak >= p_achievement.requirement_value
        WHEN 'specific_activity' THEN
            p_activity_type = p_achievement.requirement
        ELSE FALSE
    END;
END;
$$ LANGUAGE plpgsql;
```

**æ¨å®šæ™‚é–“**: 3-4æ™‚é–“

---

### ãƒ•ã‚§ãƒ¼ã‚º2: ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ç§»è¡Œï¼ˆé€±2ï¼‰

#### 2.1 Materialized Viewã®ä½œæˆ

**ç›®çš„**: ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰å–å¾—ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š

```sql
-- supabase/migrations/20251114130000_leaderboard_view.sql

-- ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰View
CREATE MATERIALIZED VIEW leaderboard AS
SELECT
    us.user_id,
    p.display_name,
    p.avatar_url,
    us.level,
    us.total_points,
    us.total_notes,
    us.current_streak,
    us.best_streak,
    ROW_NUMBER() OVER (ORDER BY us.total_points DESC, us.level DESC) AS rank
FROM user_stats us
JOIN profiles p ON us.user_id = p.user_id
ORDER BY us.total_points DESC
LIMIT 100;

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
CREATE UNIQUE INDEX leaderboard_user_id_idx ON leaderboard(user_id);
CREATE INDEX leaderboard_rank_idx ON leaderboard(rank);

-- å®šæœŸæ›´æ–°ï¼ˆ1æ™‚é–“ã”ã¨ï¼‰
CREATE OR REPLACE FUNCTION refresh_leaderboard()
RETURNS void AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY leaderboard;
END;
$$ LANGUAGE plpgsql;

-- Cron Jobã®è¨­å®šï¼ˆpg_cronãŒæœ‰åŠ¹ãªå ´åˆï¼‰
-- SELECT cron.schedule('refresh-leaderboard', '0 * * * *', 'SELECT refresh_leaderboard()');
```

**Edge Function**:
```typescript
// supabase/functions/leaderboard/index.ts
import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
import { createClient } from '@supabase/supabase-js'

serve(async (req) => {
  try {
    const supabaseClient = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
    )

    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
    const url = new URL(req.url)
    const limit = parseInt(url.searchParams.get('limit') || '50')
    const offset = parseInt(url.searchParams.get('offset') || '0')

    // ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰å–å¾—
    const { data, error } = await supabaseClient
      .from('leaderboard')
      .select('*')
      .range(offset, offset + limit - 1)

    if (error) throw error

    return new Response(JSON.stringify(data), {
      headers: { 'Content-Type': 'application/json' },
    })
  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' },
    })
  }
})
```

**æ¨å®šæ™‚é–“**: 2-3æ™‚é–“

---

### ãƒ•ã‚§ãƒ¼ã‚º3: ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ•ã‚£ãƒ¼ãƒ‰ç§»è¡Œï¼ˆé€±3ï¼‰

#### 3.1 Realtimeå¯¾å¿œ

```sql
-- supabase/migrations/20251114140000_activity_feed.sql

-- ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE activities (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    activity_type TEXT NOT NULL,
    points INT DEFAULT 0,
    metadata JSONB DEFAULT '{}'::JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX activities_user_id_idx ON activities(user_id);
CREATE INDEX activities_created_at_idx ON activities(created_at DESC);
CREATE INDEX activities_type_idx ON activities(activity_type);

-- RLSãƒãƒªã‚·ãƒ¼
ALTER TABLE activities ENABLE ROW LEVEL SECURITY;

-- å…¨å“¡ãŒé–²è¦§å¯èƒ½ï¼ˆå…¬é–‹ãƒ•ã‚£ãƒ¼ãƒ‰ï¼‰
CREATE POLICY "Anyone can view activities"
ON activities FOR SELECT
USING (true);

-- è‡ªåˆ†ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã®ã¿ä½œæˆå¯èƒ½ï¼ˆå®Ÿéš›ã¯Edge Functionã‹ã‚‰ï¼‰
CREATE POLICY "Users can create their own activities"
ON activities FOR INSERT
WITH CHECK (auth.uid() = user_id);

-- ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ•ã‚£ãƒ¼ãƒ‰Viewï¼ˆæœ€æ–°50ä»¶ï¼‰
CREATE VIEW recent_activities AS
SELECT
    a.id,
    a.activity_type,
    a.points,
    a.metadata,
    a.created_at,
    p.display_name AS user_name,
    p.avatar_url AS user_avatar,
    us.level AS user_level
FROM activities a
JOIN profiles p ON a.user_id = p.user_id
JOIN user_stats us ON a.user_id = us.user_id
ORDER BY a.created_at DESC
LIMIT 50;

-- Realtimeæœ‰åŠ¹åŒ–
ALTER publication supabase_realtime ADD TABLE activities;
```

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æ›´æ–°**:
```dart
// lib/services/activity_feed_service.dart
class ActivityFeedService {
  final SupabaseClient _supabase;
  RealtimeChannel? _subscription;

  ActivityFeedService(this._supabase);

  /// ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è³¼èª­
  Stream<List<Activity>> subscribeToActivities() {
    final controller = StreamController<List<Activity>>();

    // åˆå›ãƒ­ãƒ¼ãƒ‰
    _loadActivities().then((activities) {
      controller.add(activities);
    });

    // Realtimeè³¼èª­
    _subscription = _supabase
        .channel('public:activities')
        .onPostgresChanges(
          event: PostgresChangeEvent.insert,
          schema: 'public',
          table: 'activities',
          callback: (payload) async {
            // æ–°ã—ã„ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’å…ˆé ­ã«è¿½åŠ 
            final activities = await _loadActivities();
            controller.add(activities);
          },
        )
        .subscribe();

    return controller.stream;
  }

  Future<List<Activity>> _loadActivities() async {
    final response = await _supabase
        .from('recent_activities')
        .select()
        .order('created_at', ascending: false)
        .limit(50);

    return (response as List)
        .map((json) => Activity.fromJson(json))
        .toList();
  }

  void dispose() {
    _subscription?.unsubscribe();
  }
}
```

**æ¨å®šæ™‚é–“**: 3-4æ™‚é–“

---

## ğŸ“Š ç§»è¡Œé€²æ—ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°

| ãƒ•ã‚§ãƒ¼ã‚º | æ©Ÿèƒ½ | æ¨å®šæ™‚é–“ | å„ªå…ˆåº¦ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | å®Œäº†äºˆå®š |
|---------|------|---------|--------|----------|---------|
| 1.1 | ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ | 4-6h | ğŸ”´ Critical | â³ æœªç€æ‰‹ | Week 1 |
| 1.2 | ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆ | 3-4h | ğŸ”´ Critical | â³ æœªç€æ‰‹ | Week 1 |
| 2.1 | ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ | 2-3h | ğŸ”´ Critical | â³ æœªç€æ‰‹ | Week 2 |
| 3.1 | ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ•ã‚£ãƒ¼ãƒ‰ | 3-4h | ğŸ”´ Critical | â³ æœªç€æ‰‹ | Week 3 |
| 4.1 | äº’æ›æ€§ã‚¹ã‚³ã‚¢ | 2-3h | ğŸŸ¡ High | â³ æœªç€æ‰‹ | Week 4 |
| 5.1 | ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ | 2-3h | ğŸŸ¡ High | â³ æœªç€æ‰‹ | Week 5 |
| 6.1 | ç”»åƒç”Ÿæˆ | 4-5h | ğŸŸ¢ Medium | â³ æœªç€æ‰‹ | Week 6 |

**ç·æ¨å®šæ™‚é–“**: 20-28æ™‚é–“

---

## âœ… æˆåŠŸåŸºæº–

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- [ ] ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ãŒã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã«ç§»è¡Œ
- [ ] ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‹ã‚‰ã®ãƒã‚¤ãƒ³ãƒˆæ”¹ã–ã‚“ãŒä¸å¯èƒ½
- [ ] å…¨APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«èªè¨¼ãƒã‚§ãƒƒã‚¯

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- [ ] ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰å–å¾—ãŒ0.5ç§’ä»¥ä¸‹
- [ ] ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ•ã‚£ãƒ¼ãƒ‰ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
- [ ] ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ã®å¿œç­”æ™‚é–“ãŒ1ç§’ä»¥ä¸‹

### ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§
- [ ] åŒæ™‚ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã®ç«¶åˆçŠ¶æ…‹ãŒç™ºç”Ÿã—ãªã„
- [ ] ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒä¿è¨¼ã•ã‚Œã‚‹
- [ ] ãƒ‡ãƒ¼ã‚¿ã®ä¸æ•´åˆãŒç™ºç”Ÿã—ãªã„

---

**ä½œæˆè€…**: Claude Code
**æ‰¿èª**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚ªãƒ¼ãƒŠãƒ¼
**æ¬¡å›ãƒ¬ãƒ“ãƒ¥ãƒ¼**: ãƒ•ã‚§ãƒ¼ã‚º1å®Œäº†å¾Œ
