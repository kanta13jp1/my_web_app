name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  ENVIRONMENT: production
  FLUTTER_VERSION: '3.24.x'

jobs:
  ci:
    name: Run CI Checks
    uses: ./.github/workflows/ci.yml

  deploy:
    name: Deploy to Production Environment
    runs-on: ubuntu-latest
    needs: ci
    environment:
      name: production
      url: https://your-app.web.app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for versioning

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      # Generate version from git tags
      - name: Generate version
        id: version
        run: |
          # Get the latest tag, or use 1.0.0 if no tags exist
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          # Remove 'v' prefix if present
          VERSION=${LATEST_TAG#v}
          # Increment patch version
          IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Previous version: $VERSION"
          echo "New version: $NEW_VERSION"

      # Supabase Migration (Production)
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Run Supabase migrations
        if: ${{ secrets.SUPABASE_ACCESS_TOKEN != '' }}
        run: |
          echo "Running Supabase migrations for production..."
          # Link to production project
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID_PROD }}
          # Run migrations
          supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD_PROD }}

      # Build Flutter Web (Production with optimizations)
      - name: Build Flutter Web (Production)
        run: |
          flutter build web \
            --release \
            --web-renderer canvaskit \
            --dart-define=ENVIRONMENT=production \
            --dart-define=APP_VERSION=${{ steps.version.outputs.version }}
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL_PROD }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY_PROD }}

      - name: Verify build output
        run: |
          if [ ! -d "build/web" ]; then
            echo "Build failed: build/web directory not found"
            exit 1
          fi
          echo "Build successful!"
          ls -la build/web
          # Check build size
          BUILD_SIZE=$(du -sh build/web | cut -f1)
          echo "Build size: $BUILD_SIZE"

      # Deploy to Firebase Hosting (Production)
      - name: Deploy to Firebase Hosting (Production)
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_PROD }}'
          projectId: ${{ secrets.FIREBASE_PROJECT_ID }}
          channelId: live
        env:
          FIREBASE_CLI_EXPERIMENTS: webframeworks

      # Create release tag
      - name: Create Release Tag
        id: create_tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a ${{ steps.version.outputs.tag }} -m "Release ${{ steps.version.outputs.tag }}"
          git push origin ${{ steps.version.outputs.tag }}

      # Create GitHub Release
      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          release_name: Release ${{ steps.version.outputs.version }}
          body: |
            ## üöÄ Release ${{ steps.version.outputs.version }}

            ### Deployment Information
            - **Environment**: Production
            - **Deployed at**: ${{ github.event.head_commit.timestamp }}
            - **Commit**: ${{ github.sha }}
            - **Author**: ${{ github.actor }}

            ### Changes
            ${{ github.event.head_commit.message }}

            ### URLs
            - **Production**: https://your-app.web.app

            ---
            *This release was automatically created by GitHub Actions*
          draft: false
          prerelease: false

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: Notify Slack on success
        if: needs.deploy.result == 'success' && secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "üéâ Production deployment successful!",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üéâ Production Deployment Successful!"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Environment:* Production\n*Branch:* `${{ github.ref_name }}`\n*Commit:* `${{ github.sha }}`\n*Author:* ${{ github.actor }}\n*URL:* https://your-app.web.app"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "Deployed at <!date^${{ github.event.head_commit.timestamp }}^{date_num} {time_secs}|${{ github.event.head_commit.timestamp }}>"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on failure
        if: needs.deploy.result == 'failure' && secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "üö® Production deployment failed!",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üö® Production Deployment Failed!"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Environment:* Production\n*Branch:* `${{ github.ref_name }}`\n*Commit:* `${{ github.sha }}`\n*Author:* ${{ github.actor }}\n\n‚ö†Ô∏è *URGENT*: Production deployment has failed. Please investigate immediately!"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Logs>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Comment on commit
        if: needs.deploy.result == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: 'üéâ Successfully deployed to **Production** environment!\n\nüìç URL: https://your-app.web.app\n\nüè∑Ô∏è Release tag created'
            })
