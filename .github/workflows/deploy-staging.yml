name: Deploy to Staging

on:
  push:
    branches:
      - staging
  workflow_dispatch:

env:
  ENVIRONMENT: staging
  FLUTTER_VERSION: '3.24.x'

jobs:
  ci:
    name: Run CI Checks
    uses: ./.github/workflows/ci.yml

  deploy:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    needs: ci
    environment:
      name: staging
      url: https://staging.your-app.web.app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      # Supabase Migration (Staging)
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Run Supabase migrations
        if: ${{ secrets.SUPABASE_ACCESS_TOKEN != '' }}
        run: |
          echo "Running Supabase migrations for staging..."
          # Link to staging project
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID_STAGING }}
          # Run migrations
          supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD_STAGING }}
        continue-on-error: true

      # Build Flutter Web
      - name: Build Flutter Web (Staging)
        run: flutter build web --release --dart-define=ENVIRONMENT=staging
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL_STAGING }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY_STAGING }}

      - name: Verify build output
        run: |
          if [ ! -d "build/web" ]; then
            echo "Build failed: build/web directory not found"
            exit 1
          fi
          echo "Build successful!"
          ls -la build/web

      # Deploy to Firebase Hosting
      - name: Deploy to Firebase Hosting (Staging)
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_STAGING }}'
          projectId: ${{ secrets.FIREBASE_PROJECT_ID }}
          channelId: staging
          expires: 30d
        env:
          FIREBASE_CLI_EXPERIMENTS: webframeworks

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: Notify Slack on success
        if: needs.deploy.result == 'success' && secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "‚úÖ Staging deployment successful!",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Staging Deployment Successful* ‚úÖ\n\n*Environment:* Staging\n*Branch:* `${{ github.ref_name }}`\n*Commit:* `${{ github.sha }}`\n*Author:* ${{ github.actor }}\n*URL:* https://staging.your-app.web.app\n\n‚ö†Ô∏è Please conduct thorough testing before promoting to production."
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on failure
        if: needs.deploy.result == 'failure' && secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "‚ùå Staging deployment failed!",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Staging Deployment Failed* ‚ùå\n\n*Environment:* Staging\n*Branch:* `${{ github.ref_name }}`\n*Commit:* `${{ github.sha }}`\n*Author:* ${{ github.actor }}\n\nPlease check the workflow logs for details."
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Comment on commit
        if: needs.deploy.result == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: 'üöÄ Successfully deployed to **Staging** environment!\n\nüìç URL: https://staging.your-app.web.app\n\n‚ö†Ô∏è Please conduct thorough testing before promoting to production.'
            })
